<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Face Recognition with Firebase</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

    // ----------- Firebase config --------------
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ----------- Variables --------------
    const MODEL_URL = 'https://raw.githubusercontent.com/myselfrakib/Face/main/models';
    const video = document.getElementById('videoInput');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');

    const startBtn = document.getElementById('startBtn');
    const captureBtn = document.getElementById('captureBtn');
    const messageDiv = document.getElementById('message');

    let knownDescriptors = [];
    let knownLabels = [];
    let nextId = 100;
    let detecting = false;

    // Helper: convert Float32Array to normal array for Firebase saving
    function descriptorToArray(descriptor) {
      return Array.from(descriptor);
    }

    // Helper: convert array from Firebase back to Float32Array
    function arrayToDescriptor(arr) {
      return new Float32Array(arr);
    }

    // Load known faces from Firebase
    async function loadKnownFaces() {
      const facesRef = ref(db, 'faces');
      const snapshot = await get(facesRef);
      knownDescriptors = [];
      knownLabels = [];
      nextId = 100; // reset to 100 or find max ID from data

      if (snapshot.exists()) {
        const data = snapshot.val();
        for (const [id, face] of Object.entries(data)) {
          if (face.encoding && face.name) {
            knownDescriptors.push(arrayToDescriptor(face.encoding));
            knownLabels.push(face.name);
            const numericId = parseInt(id, 10);
            if (!isNaN(numericId) && numericId >= nextId) nextId = numericId + 1;
          }
        }
      }
      console.log(`Loaded ${knownLabels.length} faces. Next ID: ${nextId}`);
    }

    // Save face + name + age + height to Firebase
    async function saveFace(descriptor) {
      const id = nextId++;
      const nameInput = document.getElementById('inputName').value.trim();
      const ageInput = parseInt(document.getElementById('inputAge').value);
      const heightInput = parseInt(document.getElementById('inputHeight').value);

      if (!nameInput) {
        messageDiv.innerText = "Please enter a name.";
        nextId--; // revert ID increment since not saving
        return;
      }
      if (!ageInput || ageInput < 1 || ageInput > 120) {
        messageDiv.innerText = "Please enter a valid age (1-120).";
        nextId--;
        return;
      }
      if (!heightInput || heightInput < 30 || heightInput > 300) {
        messageDiv.innerText = "Please enter a valid height in cm (30-300).";
        nextId--;
        return;
      }

      const faceRef = ref(db, `faces/${id}`);
      await set(faceRef, {
        name: nameInput,
        age: ageInput,
        height: heightInput,
        encoding: descriptorToArray(descriptor),
        timestamp: new Date().toISOString()
      });

      knownDescriptors.push(descriptor);
      knownLabels.push(nameInput);

      messageDiv.innerText = `Saved face data for ${nameInput}`;
      console.log(`Saved face for ${nameInput} with ID ${id}`);
    }

    async function setup() {
      messageDiv.innerText = "Loading models...";
      await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
      ]);
      messageDiv.innerText = "Models loaded.";

      await loadKnownFaces();

      startBtn.disabled = false;
      captureBtn.disabled = true;
    }

    async function startCamera() {
      messageDiv.innerText = "Starting camera...";
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
        video.srcObject = stream;
        await video.play();
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        messageDiv.innerText = "Camera started. Face the camera and click Capture Face.";
        captureBtn.disabled = false;
        startBtn.disabled = true;
        detecting = true;
        recognizeLoop();
      } catch (err) {
        messageDiv.innerText = "Failed to start camera: " + err.message;
        console.error(err);
      }
    }

    async function recognizeLoop() {
      if (!detecting) return;

      // Detect faces with tinyFaceDetector for speed
      const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptors();

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (detections.length === 0) {
        messageDiv.innerText = "No face detected. Please make sure your face is visible.";
      } else {
        messageDiv.innerText = "Face detected. You can capture now.";
      }

      for (const detection of detections) {
        const box = detection.detection.box;

        ctx.strokeStyle = "blue";
        ctx.lineWidth = 2;
        ctx.strokeRect(box.x, box.y, box.width, box.height);
      }

      requestAnimationFrame(recognizeLoop);
    }

    // Capture face button click
    captureBtn.onclick = async () => {
      const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

      if (!detections) {
        messageDiv.innerText = "No face detected to capture. Please try again.";
        return;
      }

      await saveFace(detections.descriptor);
    };

    startBtn.onclick = startCamera;

    setup();
  </script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      text-align: center;
      background: #222;
      color: white;
      font-family: Arial, sans-serif;
    }
    #videoInput {
      position: absolute;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      transform: scaleX(-1); /* mirror */
    }
    #overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      transform: scaleX(-1);
    }
    #controls {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      padding: 15px;
      border-radius: 8px;
      z-index: 1000;
    }
    #controls input {
      font-size: 14px;
      padding: 6px 8px;
      margin: 5px 6px 0 0;
      width: 120px;
      border-radius: 4px;
      border: none;
      outline: none;
    }
    #controls button {
      font-size: 14px;
      padding: 7px 12px;
      margin: 10px 6px 0 0;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background-color: #06c;
      color: white;
      transition: background-color 0.3s ease;
    }
    #controls button:disabled {
      background-color: #444;
      cursor: not-allowed;
    }
    #message {
      margin-top: 10px;
      font-weight: bold;
      color: #ffcc00;
      min-height: 20px;
    }
  </style>
</head>
<body>
  <video id="videoInput" autoplay muted></video>
  <canvas id="overlay"></canvas>

  <div id="controls">
    <input type="text" id="inputName" placeholder="Name" />
    <input type="number" id="inputAge" placeholder="Age" min="1" max="120" />
    <input type="number" id="inputHeight" placeholder="Height (cm)" min="30" max="300" />
    <br />
    <button id="startBtn" disabled>Start Camera</button>
    <button id="captureBtn" disabled>Capture Face</button>
    <div id="message"></div>
  </div>
</body>
</html>
