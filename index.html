<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Face Encoding to Firebase</title>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
</head>
<body>
  <h2>Face Recognition Data Capture</h2>
  <video id="video" width="320" height="240" autoplay muted></video>
  <br>
  <button id="captureBtn">Capture Face Data</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.firebasestorage.app",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Start camera
    const video = document.getElementById('video');
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream);

    // Load models
    Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri('/models'),
      faceapi.nets.faceLandmark68Net.loadFromUri('/models'),
      faceapi.nets.faceRecognitionNet.loadFromUri('/models')
    ]).then(() => {
      console.log("Face-api.js models loaded");
    });

    // Capture button
    document.getElementById("captureBtn").addEventListener("click", async () => {
      const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

      if (!detection) {
        alert("No face detected. Please try again.");
        return;
      }

      // Get descriptor and convert to array
      const descriptorArray = Array.from(detection.descriptor);

      // Save to Firebase (replace with your userId/bookingId)
      const bookingId = "BOOKING123";
      await set(ref(db, `faceEncodings/${bookingId}`), {
        encoding: descriptorArray
      });

      alert("Face encoding saved successfully!");
    });
  </script>
</body>
</html>
