<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Face Recognition with Firebase - Centered View</title>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
    authDomain: "wavetravel-3c4c4.firebaseapp.com",
    databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
    projectId: "wavetravel-3c4c4",
    storageBucket: "wavetravel-3c4c4.appspot.com",
    messagingSenderId: "298226098137",
    appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const MODEL_URL = 'https://raw.githubusercontent.com/myselfrakib/Face/main/models';

  const video = document.getElementById('videoInput');
  const canvas = document.getElementById('overlay');
  const ctx = canvas.getContext('2d');

  let knownDescriptors = [];
  let knownLabels = [];
  let nextId = 100;

  let detectionActive = false;
  let processingUnknown = false;
  let unknownDescriptor = null;
  let unknownBox = null;

  function descriptorToArray(descriptor) {
    return Array.from(descriptor);
  }
  function arrayToDescriptor(arr) {
    return new Float32Array(arr);
  }

  async function loadKnownFaces() {
    const facesRef = ref(db, 'faces');
    const snapshot = await get(facesRef);
    knownDescriptors = [];
    knownLabels = [];
    nextId = 100;

    if (snapshot.exists()) {
      const data = snapshot.val();
      for (const [id, face] of Object.entries(data)) {
        if (face.encoding && face.name) {
          knownDescriptors.push(arrayToDescriptor(face.encoding));
          knownLabels.push(face.name);
          const numericId = parseInt(id, 10);
          if (!isNaN(numericId) && numericId >= nextId) nextId = numericId + 1;
        }
      }
    }
    console.log(`Loaded ${knownLabels.length} faces. Next ID: ${nextId}`);
  }

  async function saveNewFace(name, age) {
    if (!unknownDescriptor || !unknownBox) return;

    const id = nextId++;
    const faceRef = ref(db, `faces/${id}`);

    await set(faceRef, {
      name,
      age,
      encoding: descriptorToArray(unknownDescriptor),
      timestamp: new Date().toISOString()
    });

    knownDescriptors.push(unknownDescriptor);
    knownLabels.push(name);
    unknownDescriptor = null;
    unknownBox = null;
    console.log(`Saved new face: ${name} (ID ${id})`);
  }

  async function setup() {
    await Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
      faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
      faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
    ]);
    await loadKnownFaces();

    const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
    video.srcObject = stream;
    await video.play();

    // Fixed size centered video & canvas
    const width = 640;
    const height = 480;

    video.width = width;
    video.height = height;

    canvas.width = width;
    canvas.height = height;

    detectionActive = true;
    recognizeLoop();
  }

  function flipBoxHorizontally(box, width) {
    return {
      x: width - box.x - box.width,
      y: box.y,
      width: box.width,
      height: box.height
    };
  }

  async function recognizeLoop() {
    if (!detectionActive) return;

    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
      .withFaceLandmarks()
      .withFaceDescriptors();

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (detections.length === 0) {
      requestAnimationFrame(recognizeLoop);
      return;
    }

    // Only first face for simplicity
    const detection = detections[0];
    let box = detection.detection.box;
    const descriptor = detection.descriptor;

    // Flip box horizontally because video is mirrored
    box = flipBoxHorizontally(box, canvas.width);

    let bestMatch = { distance: 1.0, label: "Unknown" };
    for (let i = 0; i < knownDescriptors.length; i++) {
      const dist = faceapi.euclideanDistance(descriptor, knownDescriptors[i]);
      if (dist < bestMatch.distance) {
        bestMatch = { distance: dist, label: knownLabels[i] };
      }
    }
    const threshold = 0.5;
    const matched = bestMatch.distance < threshold;

    if (matched) {
      ctx.strokeStyle = "green";
      ctx.lineWidth = 3;
      ctx.strokeRect(box.x, box.y, box.width, box.height);
      ctx.fillStyle = "green";
      ctx.font = "18px Arial";
      ctx.fillText(`${bestMatch.label} (${bestMatch.distance.toFixed(2)})`, box.x, box.y > 20 ? box.y - 8 : box.y + 20);
      processingUnknown = false;
      unknownDescriptor = null;
      unknownBox = null;
      requestAnimationFrame(recognizeLoop);
    } else {
      if (!processingUnknown) {
        processingUnknown = true;
        unknownDescriptor = descriptor;
        unknownBox = box;
        drawRedBox(box);
        setTimeout(() => {
          detectionActive = false;
          showForm();
        }, 3000);
      } else {
        drawRedBox(unknownBox);
      }
    }
  }

  function drawRedBox(box) {
    ctx.strokeStyle = "red";
    ctx.lineWidth = 3;
    ctx.strokeRect(box.x, box.y, box.width, box.height);
    ctx.fillStyle = "red";
    ctx.font = "18px Arial";
    ctx.fillText(`Unknown`, box.x, box.y > 20 ? box.y - 8 : box.y + 20);
  }

  const formContainer = document.getElementById('formContainer');
  const nameInput = document.getElementById('nameInput');
  const ageInput = document.getElementById('ageInput');
  const saveBtn = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');

  function showForm() {
    formContainer.style.display = 'block';
    nameInput.value = '';
    ageInput.value = '';
    nameInput.focus();
  }

  async function saveForm() {
    const name = nameInput.value.trim();
    const age = parseInt(ageInput.value);

    if (!name) {
      alert("Please enter a name");
      nameInput.focus();
      return;
    }
    if (!age || age < 1 || age > 120) {
      alert("Please enter a valid age (1-120)");
      ageInput.focus();
      return;
    }

    await saveNewFace(name, age);
    formContainer.style.display = 'none';
    detectionActive = true;
    processingUnknown = false;
    unknownDescriptor = null;
    unknownBox = null;
    recognizeLoop();
  }

  function cancelForm() {
    formContainer.style.display = 'none';
    detectionActive = true;
    processingUnknown = false;
    unknownDescriptor = null;
    unknownBox = null;
    recognizeLoop();
  }

  saveBtn.addEventListener('click', saveForm);
  cancelBtn.addEventListener('click', cancelForm);

  setup();
</script>

<style>
  body {
    margin: 0; padding: 0;
    background: #222;
    font-family: Arial, sans-serif;
    color: white;
    display: flex;
    height: 100vh;
    align-items: center;
    justify-content: center;
  }
  #videoInput {
    width: 640px;
    height: 480px;
    object-fit: cover;
    transform: scaleX(-1); /* mirror video */
    border-radius: 8px;
    box-shadow: 0 0 15px #0f0;
  }
  #overlay {
    position: absolute;
    width: 640px;
    height: 480px;
    pointer-events: none;
    transform: none; /* canvas NOT mirrored */
    border-radius: 8px;
  }
  #formContainer {
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.95);
    border-radius: 10px;
    padding: 20px;
    z-index: 10;
    width: 300px;
    box-shadow: 0 0 15px #0f0;
  }
  #formContainer label {
    display: block;
    margin-bottom: 6px;
  }
  #formContainer input {
    width: 100%;
    padding: 8px;
    margin-bottom: 12px;
    border-radius: 4px;
    border: none;
    font-size: 16px;
  }
  #formContainer button {
    width: 48%;
    padding: 8px;
    margin-right: 4%;
    font-size: 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  #saveBtn {
    background-color: #28a745;
    color: white;
  }
  #cancelBtn {
    background-color: #dc3545;
    color: white;
    margin-right: 0;
  }
  /* Container to position video + canvas */
  #videoWrapper {
    position: relative;
    width: 640px;
    height: 480px;
  }
  #overlay {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 2;
  }
  #videoInput {
    position: relative;
    z-index: 1;
  }
</style>
</head>
<body>
  <div id="videoWrapper">
    <video id="videoInput" autoplay muted></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="formContainer">
    <label for="nameInput">Name:</label>
    <input id="nameInput" type="text" placeholder="Enter name" />
    <label for="ageInput">Age:</label>
    <input id="ageInput" type="number" min="1" max="120" placeholder="Enter age" />
    <button id="saveBtn">Save</button>
    <button id="cancelBtn">Cancel</button>
  </div>
</body>
</html>
