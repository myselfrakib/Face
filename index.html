<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Auto Face Capture & Save</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f5f5f5;
    padding: 20px;
  }
  video, canvas {
    border: 2px solid #333;
    border-radius: 10px;
    margin-top: 10px;
  }
  #status {
    font-weight: bold;
    margin-top: 10px;
    color: green;
  }
</style>
</head>
<body>

<h2>Auto Face Capture & Save to Firebase</h2>
<video id="video" width="320" height="240" autoplay muted></video>
<canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
<div id="status">Loading models...</div>

<!-- Face API -->
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
  authDomain: "wavetravel-3c4c4.firebaseapp.com",
  databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
  projectId: "wavetravel-3c4c4",
  storageBucket: "wavetravel-3c4c4.appspot.com",
  messagingSenderId: "298226098137",
  appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
};

// Init Firebase
const app = initializeApp(firebaseConfig);
const storage = getStorage(app);
const db = getDatabase(app);

// HTML Elements
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const statusDiv = document.getElementById('status');

// Load face-api models
Promise.all([
  faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/weights'),
]).then(startVideo);

function startVideo() {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => { video.srcObject = stream; })
    .catch(err => { console.error(err); });
}

// Get next ticket name
async function getNextTicketName() {
  const snapshot = await get(ref(db, "lastTicketNumber"));
  let number = snapshot.exists() ? snapshot.val() + 1 : 101;
  await set(ref(db, "lastTicketNumber"), number);
  return "ticket" + number;
}

// Detect face and capture
video.addEventListener('playing', async () => {
  statusDiv.innerText = "Detecting face...";
  const displaySize = { width: video.width, height: video.height };
  setInterval(async () => {
    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
    if (detections.length > 0) {
      statusDiv.innerText = "Face detected! Capturing...";
      captureAndSave();
    }
  }, 1000);
});

async function captureAndSave() {
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  canvas.toBlob(async (blob) => {
    const ticketName = await getNextTicketName();
    const imgRef = storageRef(storage, `faces/${ticketName}.png`);
    await uploadBytes(imgRef, blob);
    const url = await getDownloadURL(imgRef);
    await set(ref(db, `tickets/${ticketName}`), { imageUrl: url, createdAt: Date.now() });
    statusDiv.innerText = `Saved as ${ticketName}`;
  }, 'image/png');
}
</script>

</body>
</html>
