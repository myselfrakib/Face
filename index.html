<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Face Ticket System</title>
<style>
  body { text-align: center; background: #111; color: white; font-family: Arial; }
  canvas { position: absolute; top: 0; left: 0; }
  #video { border: 2px solid white; border-radius: 10px; }
  #datetime { font-size: 20px; margin-top: 10px; }
  button { margin-top: 15px; padding: 10px 20px; font-size: 16px; border-radius: 5px; border: none; cursor: pointer; }
</style>
</head>
<body>

<h1>Face Ticket Recognition</h1>
<video id="video" width="720" height="560" autoplay muted></video>
<canvas id="overlay" width="720" height="560"></canvas>
<div id="datetime"></div>
<button id="generateBtn">Generate Ticket</button>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
    authDomain: "wavetravel-3c4c4.firebaseapp.com",
    databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
    projectId: "wavetravel-3c4c4",
    storageBucket: "wavetravel-3c4c4.firebasestorage.app",
    messagingSenderId: "298226098137",
    appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Live date & time display
  function updateDateTime() {
    const now = new Date();
    document.getElementById('datetime').innerText = now.toLocaleString();
  }
  setInterval(updateDateTime, 1000);

  // Load face-api models
  Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri('/models'),
    faceapi.nets.faceLandmark68Net.loadFromUri('/models'),
    faceapi.nets.faceRecognitionNet.loadFromUri('/models')
  ]).then(startVideo);

  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const ctx = overlay.getContext('2d');
  let currentDescriptor = null;

  function startVideo() {
    navigator.mediaDevices.getUserMedia({ video: {} })
      .then(stream => video.srcObject = stream)
      .catch(err => console.error(err));
  }

  video.addEventListener('play', () => {
    const displaySize = { width: video.width, height: video.height };
    faceapi.matchDimensions(overlay, displaySize);

    setInterval(async () => {
      const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptors();

      ctx.clearRect(0, 0, overlay.width, overlay.height);

      if (detections.length > 0) {
        currentDescriptor = detections[0].descriptor;
        const box = detections[0].detection.box;

        // Draw circle if no ticket found
        const centerX = box.x + box.width / 2;
        const centerY = box.y + box.height / 2;
        const radius = Math.max(box.width, box.height) / 2;

        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
        ctx.lineWidth = 3;
        ctx.strokeStyle = 'red';
        ctx.stroke();
      }
    }, 200);
  });

  // Generate Ticket
  document.getElementById('generateBtn').addEventListener('click', async () => {
    if (!currentDescriptor) {
      alert("No face detected!");
      return;
    }

    const now = new Date();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();
    const ticketBase = `${month}${year}101`;

    // Check latest ticket number in DB
    const dbRef = ref(db);
    const snapshot = await get(child(dbRef, 'tickets'));
    let ticketNum = ticketBase;
    if (snapshot.exists()) {
      const allTickets = Object.keys(snapshot.val());
      const lastTicket = allTickets.sort().pop();
      if (lastTicket && lastTicket.startsWith(`${month}${year}`)) {
        ticketNum = String(Number(lastTicket) + 1);
      }
    }

    // Save ticket with face descriptor
    await set(ref(db, 'tickets/' + ticketNum), {
      descriptor: Array.from(currentDescriptor),
      timestamp: now.toISOString()
    });

    alert(`Ticket ${ticketNum} generated!`);
  });
</script>

<!-- Face API JS -->
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

</body>
</html>
